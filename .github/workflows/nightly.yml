name: 最新版

on: [push, pull_request]

env:
  BINARY_PREFIX: "zbp_"
  BINARY_SUFFIX: ""
  PR_PROMPT: "::warning:: Build artifact will not be uploaded due to the workflow is trigged by pull request."
  LD_FLAGS: "-w -s"

jobs:
  build:
    name: Build Linux amd64 Binary
    runs-on: ubuntu-latest
    # 移除多架构矩阵，直接指定目标系统和架构
    steps:
      - uses: actions/checkout@master
      - name: Setup Go environment
        uses: actions/setup-go@master
        with:
          go-version: '1.20'
      - name: Cache downloaded module
        uses: actions/cache@master
        continue-on-error: true
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          # 缓存key简化（只对应linux_amd64）
          key: ${{ runner.os }}-go-linux-amd64-${{ hashFiles('**/go.sum') }}
      - name: Build binary file
        env:
          # 直接硬编码目标架构，无需matrix
          GOOS: linux
          GOARCH: amd64
          IS_PR: ${{ !!github.head_ref }}
        run: |
          # 1. 设置Go代理，加速依赖下载
          export GOPROXY=https://goproxy.cn,direct
          # 2. 同步依赖（自动更新go.mod/go.sum，解决依赖缺失）
          go mod tidy
          # 3. 确保输出目录存在，避免编译失败
          mkdir -p output
          # 4. 无需判断系统（固定linux），直接拼接文件名
          export BINARY_NAME="${BINARY_PREFIX}${GOOS}_${GOARCH}${BINARY_SUFFIX}"
          export CGO_ENABLED=0
          # 5. 编译（添加-v参数，输出详细日志便于调试）
          go build -v -o "output/$BINARY_NAME" -trimpath -ldflags "$LD_FLAGS" .
      - name: Upload artifact
        uses: actions/upload-artifact@master
        if: ${{ !github.head_ref }}
        with:
          # 产物名称简化（直接对应linux_amd64）
          name: linux_amd64
          path: output/
